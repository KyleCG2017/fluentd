apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: fluentd-application
  namespace: argocd
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: monitoring
  source:
    chart: fluentd
    repoURL: https://fluent.github.io/helm-charts
    targetRevision: 0.5.2
    helm:
      values: |
        image:
          repository: fluent/fluentd-kubernetes-daemonset
          tag: v1.18-debian-papertrail-1
        resources:
          requests:
            cpu: 10m
            memory: 128Mi
          limits:
            memory: 128Mi
        autoscaling:
          enabled: true
          minReplicas: 1
          maxReplicas: 2
          targetCPUUtilizationPercentage: 80
        serviceAccount:
          create: true
          name: fluentd-role
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::<YOUR_ACCOUNT_ID>:role/<YOUR_FLUENTD_ROLE>
        plugins:
          - fluent-plugin-grafana-loki
          - fluent-plugin-cloudwatch-logs
          - fluent-plugin-elasticsearch
        fileConfigs:
          "01_sources.conf": |
            <source>
              @type tail
              @id in_tail_test_logs
              @label @KUBERNETES
              path /var/log/test/*.log
              pos_file /var/log/fluentd-test-logs.log.pos
              tag test.*
              read_from_head true
              <parse>
                @type none
              </parse>
            </source>
          "02_filters.conf": |
            <label @KUBERNETES>
              <match kubernetes.var.log.containers.fluentd**>
                @type relabel
                @label @FLUENT_LOG
              </match>
              <filter kubernetes.**>
                @type record_transformer
                enable_ruby
                <record>
                  hostname ${record["kubernetes"]["host"]}
                  raw ${record["log"]}
                </record>
                remove_keys $.kubernetes.host,log
              </filter>
              <match **>
                @type relabel
                @label @DISPATCH
              </match>
            </label>
          "03_dispatch.conf": |
            <label @DISPATCH>
              <filter **>
                @type prometheus
                <metric>
                  name fluentd_input_status_num_records_total
                  type counter
                  desc The total number of incoming records
                  <labels>
                    tag ${tag}
                    hostname ${hostname}
                  </labels>
                </metric>
              </filter>
              <match **>
                @type relabel
                @label @OUTPUT
              </match>
            </label>
          "04_outputs.conf": |
            <label @OUTPUT>
              <match test.**>
                @type stdout
              </match>
            </label>
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
